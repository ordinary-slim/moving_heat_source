\subsection{Brief description of reference model}
  \input{reference_model.tex}

\subsection{Proposed model}

Let us denote the change of reference frame by

$$
\mathbf{\xi} = \mathbf{x} - \int_0^t \mathbf{V}(t) dt
$$

, where $\mathbf{V} = f(t)$ denotes the
speed of the laser.
The proposed model is as follows:
in a \textit{moving} subdomain attached to the heat source,
$\Omega_m \subset \Omega$,
the problem is posed in the reference frame of the heat source.
In the remaining
\textit{fixed} subdomain $\Omega_f \subset \Omega$,
the problem is posed
in the usual laboratory reference frame.
The chosen domain decomposition framework is
a standard Neumann Dirichlet non-overlapping decomposition,
hence $\Omega_f = (\Omega \setminus \Omega_m)^{\mathrm{o}}$,
where ${}^{\mathrm{o}}$ denotes the interior of a set. Let
$\Gamma$ denote the interface between both subdomains,
$\Gamma = \partial \Omega_m \cap \partial \Omega_f$. In this
setting, system \eqref{eq:refheateq} can be rewritten as
a coupled PDE system

\begin{align}
  \rho c_p \Big( \partial_t T^m{\scriptstyle (\xi, t)} - \mathbf{V} \cdot \nabla T^m{\scriptstyle (\xi, t)} \Big) -
  \nabla \cdot ( k \nabla T^m{\scriptstyle (\xi, t)}) &= r{\scriptstyle (\xi)}  &\xi &\in \Omega_m \label{eq:pdeddm}\\
  k \partial_n T^m{\scriptstyle (\xi, t)} &= k \partial_n T^f  &\xi &\in \Gamma \notag\\
  q_{\textrm{conv}} &= h_{\textrm{conv}} ( T^m{\scriptstyle(\xi,t)} - T_{\textrm{env}} ) \qquad &\xi &\in \partial \Omega_{m, \textrm{conv}}\notag\\
  \rho c_p \partial_t T^f{\scriptstyle (x, t)} - \nabla \cdot (k \nabla T^f{\scriptstyle (x, t)}) &= r{\scriptstyle (x, t)} \qquad &x &\in \Omega_f \label{eq:pdedf}\\
  T^f{\scriptstyle (x, t)} &= T^m \qquad &x &\in \Gamma \label{eq:dirichletdf}\\
  q_{\textrm{conv}} &= h_{\textrm{conv}} ( T^f{\scriptstyle(x,t)} - T_{\textrm{env}} ) \qquad &x &\in \partial \Omega_{f, \textrm{conv}}\notag
\end{align}

\begin{figure}
  \centering
  \castelincfig[0.6]{nonOverlappingPartition}
  \caption{Schematic of proposed model.}
  \label{fig:schematic}
\end{figure}

Note that the time dependency of heat source
is absent from \eqref{eq:pdeddm}. Ideally, $\Omega_m$ is big enough
to contain the whole support of the heat source such that
the right hand side of \eqref{eq:pdedf} is null.
For both this model and the reference, the spatial discretization
is carried out using P1/Q1 finite elements and Backward Euler
time integration. \citep{Puso2023} mentions that higher order
time integrations will introduce further oscillations.
\textit{Streamline Upwind Petrov-Galerkin} (SUPG) stabilization is chosen
in order to take care of the newly introduced advection term
in \eqref{eq:pdeddm}. The corresponding semi-discrete weak forms write

\todo{Explain notation}
\todo{Add test funcs and solutions spaces etc}

\begin{align}
  \label{eq:weakformdm}
    \int_{\Omega_m} v_m \rho c_p \partial_t T_h^m 
  - \int_{\Omega_m} v_m \rho c_p \mathbf{V} \cdot \nabla T_h^m
  + \int_{\Omega_m} k \nabla v_m \cdot \nabla T_h^m&\\
  - \int_{\partial \Omega_{m, \textrm{conv}}} \hspace{-8mm} v_m \mathbf{q_{conv}} \cdot \hat{n}
  - \int_{\Gamma} k v_m \nabla T_h^f \cdot \hat{n} &\notag\\
  + \int_{\Omega_m} \tau R_h\dependson{T_h} \rho \mathbf{V} \cdot \nabla v_m &= \int_{\Omega_m} v_m r \notag\\
  \label{eq:weakformdf}
    \int_{\Omega_f} v_f \rho c_p \partial_t T_h^f 
  + \int_{\Omega_f} k \nabla v_f \cdot \nabla T_h^f
  - \int_{\partial \Omega_{f, \textrm{conv}}} \hspace{-8mm} v_f \mathbf{q_{conv}} \cdot \hat{n} &= \int_{\Omega_f} v_f r
\end{align}

, where $R_h = f(T_h)$ denotes the residual of equation \eqref{eq:pdeddm}

$$
R_h(T_h) = \rho c_p \partial_t T_h + \rho c_p \mathbf{V} \cdot \nabla T_h - \nabla \cdot ( k \nabla T_h) - r
$$

and $\tau$ is chosen according to \cite{Codina2000}.
The described coupled problem is solved for monolitically.
Note that the Dirichlet values of boundary condition
\eqref{eq:dirichletdf} are not known before solving,
hence they have to be imposed at the algebraic level.
The resulting linear system writes

\begin{equation}\label{eq:algebraic_coupled}
  \begin{pmatrix}
    \frac{\tilde{M}_m}{\Delta t} + A_{m, m} & A_{m, m_\Gamma} & \cdot & \cdot \\[3mm]
    A_{m_\Gamma, m} & \frac{\tilde{M}_{m_\Gamma}}{\Delta t} + A_{m_\Gamma, m_\Gamma} & \cdot & A_{m_\Gamma, f_\Gamma}  \\[3mm]
    \cdot & A_{f, m_\Gamma} & \frac{\tilde{M}_{f}}{\Delta t}  + A_{f, f} & A_{f, f_\Gamma}  \\[3mm]
    \cdot & C & \cdot & -I
  \end{pmatrix}
  \begin{pmatrix}
    T_h^{m, n+1}          \\[3mm]
    T_h^{m_\Gamma, n+1} \\[3mm]
    T_h^{f, n+1}          \\[3mm]
    T_h^{f_\Gamma, n+1}
  \end{pmatrix}
  =
  \begin{pmatrix}
    F_m          + \frac{\tilde{M}_m}{\Delta t} T_h^{m, n}\\[3mm]
    F_{m_\Gamma} + \frac{\tilde{M}_{m_\Gamma}}{\Delta t} T_h^{m_\Gamma, n}\\[3mm]
    F_{f}        + \frac{\tilde{M}_{f}}{\Delta t} T_h^{f,n}\\[3mm]
    \cdot
  \end{pmatrix}
\end{equation}
, where $\tilde{M}$ matrices denote modified mass matrices with
an extra SUPG term, , the \textit{A} matrices are stiffness
matrices and $C$ is a matrix whose rows add up to 1.\par

The adoption of this model introduces as a variable
the choice of $\Omega_m$. Moreover,
this work is based on the premise that
the problem close to the heat source is steadier.
This is taken advantage from by measuring
the steadiness of the moving subproblem and
choosing a bigger $\Delta t$ when the metric
passes some threshold.
The choice of $\Omega_m$ depends on the choice of
$\Delta t$ since if $\Omega_m$ is shorter than
$V \Delta t$, elements of $\Omega_m$ are skipped
over. This is analogous to the constraint \eqref{eq:origconstraint},
with the advantage here that $\Omega_m$ can be chosen at every timestep.\par

\subsubsection{Choosing \texorpdfstring{$\Delta t$}{dt}}
At the beginning of a heating track, \enskip
$\Delta t$ is initialized to a fine value,
$\Delta t = 0.5 \mathcal{R}$ .
At the end of each timestep, the steadiness
of the subproblem on $\Omega_m$ is measured 
using a metric of choice, e.g.
\begin{equation}\label{eq:steadinessmetric}
  \textrm{Steadiness metric} = \frac{||T_h^{m, n+1} - T_h^{m, n}||_2}{|| T_h^{m, n+1} ||_2}
\end{equation}

Other possibilities include the relative variation
of the maximum or mean temperatures, or combinations
of the aforementioned metrics. When the metric of choice
passes some threshold, $\Delta t$ is increased
by some factor or by adding a constant. In theory,
choices of $\Delta t$ are constrained
by the requirement that the decomposition is non-overlapping.
Assuming a constant element size $h$
for both the meshes of $\Omega_m$ and $\Omega_f$,
it is necessary that
\begin{equation}\label{eq:nonoverlapconstraint}
  \frac{V \Delta t}{h} \in \mathbb{N}
\end{equation}
in order to go from a non-overlapping decomposition to another.
In practice, constraint \eqref{eq:nonoverlapconstraint} is not enforced
in the proposed scheme and although moderate overlaps occur, they do
not result in noticeable error.

\subsubsection{Choosing \texorpdfstring{$\Omega_m$}{Omega m}}

\begin{figure}[]
  \centering
  \includegraphics[width=0.5\textwidth]{2d_am/quadTriang.png}
  \caption{$\Omega_m$ can be meshed with different element type and size.}
  \label{fig:quadtriang}
\end{figure}

Both problems on $\Omega_m$ and $\Omega_f$
are meshed separately, hence if both meshes
have the same mesh size the interface nodes are duplicated.
Note that different elements types and sizes
can be used for $\Omega_m$ and $\Omega_f$ (cf. figure \ref{fig:quadtriang}).
\cite{Storti2022, carraturo2021twolevel} advocate for this approach
in order to tackle the spatial multiscale nature of
the problem, with the advantage over Adaptive Mesh Refinement
that it is not necessary to recompute connectivities at
each timestep.\par

The scheme itself imposes or suggests  the following
constraints on the size of $\Omega_m$, namely:
\begin{enumerate}
  \item\label{it:subset} $\Omega_m$ must be a subset of $\Omega$: it is necessary
    to enforce
    \begin{equation}\label{eq:subset}
      \Omega_m ( t^n ) \subset \Omega ( t^n )
      \hspace{2.5cm}
      \Omega_m ( t^{n+1} ) \subset \Omega ( t^{n+1} )
    \end{equation}
  \item\label{it:support} $\Omega_m$ should be big enough to contain the support
    of the heat source. Note that for the Gaussian heat
    source \eqref{eq:heatsource}, \enskip 
    at 1.5 radii away, the relative power density with respect
    to the maximum is around 0.1\%.
  \item\label{it:skip} $\Omega_m$ should be long enough to not skip over elements
    of $\Omega_f$ i.e. the tail of $\Omega_m$ should be at least
    $V \Delta t$ long.
  \item\label{it:diff} $\Omega_m$ should not be too big due to the extra numerical
    diffusion added by the advection term.
\end{enumerate}

\begin{figure}[h]
  \begin{subfigure}[t]{0.49\textwidth}
    \includegraphics[width=\textwidth]{2d_meshing_example/afterShaping.png}
    \caption{From \cref{it:support,it:skip,it:diff}, one can obtain
    a mesh for $\Omega_m$ like the one shown above.}
  \end{subfigure}
  \hfill%
  \begin{subfigure}[t]{0.49\textwidth}
    \includegraphics[width=\textwidth]{2d_meshing_example/after_intersec1.png}
    \caption{After the first intersection at $t^n$.}
  \end{subfigure}
  \begin{subfigure}[t]{0.49\textwidth}
    \includegraphics[width=\textwidth]{2d_meshing_example/after_intersec2.png}
    \caption{After the second intersection at $t^{n+1}$.}
  \end{subfigure}
  \hfill%
  \begin{subfigure}[t]{0.49\textwidth}
    \includegraphics[width=\textwidth]{2d_meshing_example/dd.png}
    \caption{After substracting $\Omega_m$ from $\Omega_f$, a decomposition
    is obtained.}
  \end{subfigure}
  \caption{Illustration of meshing process for $\Omega_m$}
  \label{fig:2d_meshing_example}
\end{figure}

$\Omega_m$ is reshaped as needed at each timestep
without remeshing. This is achieved by meshing an elongated block,
which will work as a background mesh for $\Omega_m$,
and using the birth-death element technique along geometrical
operations like mesh intersection and difference.
Similarly, at the beginning of each timestep, the mesh of $\Omega_f$ corresponds to
a mesh of $\Omega(t^n)$
and a mesh difference $\Omega_f \leftarrow \Omega_f \setminus \Omega_m$
is performed in order to obtain the decomposition.
\Cref{fig:2d_meshing_example} illustrates this process
on a problem without deposition.
From \cref{it:support,it:skip,it:diff}, a potential mesh for $\Omega_m$
is obtained and it is left to enforce \cref{it:subset}.
At $t^n$, the candidate mesh for $\Omega_m$
is intersected with the mesh
of $\Omega_f$.
Mesh motion is carried out for $\Omega_m$.
Then, , at $t^{n+1}$, the displaced mesh of $\Omega_m$
is intersected again with the mesh of $\Omega_f$.
Finally, the resulting mesh for $\Omega_m$
is substracted from the mesh of $\Omega_f$ in order to obtain
the domain decomposition.
For additive manufacturing problems, the deposition
is carried out in $\Omega_m$ after these operations.\par

The aforementioned mesh operations (intersection, difference)
are implemented by projecting a finite element function
with value 1 at the active nodes and 0 at the inactive nodes.
At the receiving end of the projection, elements whom all of their nodes
are 1-valued are declared as owned by the other mesh.\par

\begin{algorithm}
    \caption{Timestep}
    \label{alg:timestep}
    \begin{algorithmic} % The number tells where the line numbering should start
        \LComment{Domains of pMoving and pFixed are $\Omega_m$ and $\Omega_f$ respectively.}
        \State Reset activation on $\Omega_m$
        \State Set activation of $\Omega_f$ to $\Omega$
        \State Set $\Delta t$
        \LComment{if on new track, settings}
        \State Shape $\Omega_m$
        \State $\Omega_m \cap \Omega_f$
        \State Preiterate
        \State $\Omega_m \cap \Omega_f$
        \State Do deposition in $\Omega_m$
        \State $\Omega_f \setminus \Omega_m$
        \State Locate $\Gamma$ on both domains
        \LComment{BCs}
        \State Set gamma $\Omega_f$ to Dirichlet
        \State Set gamma $\Omega_m$ to Neumann
        \State Set BCs
        \State Assemble pMoving and pFixed
        \State Solve linear system
        \State Interpolate inactive nodes of both
        \State Compute steadiness and new $\Delta t$
    \end{algorithmic}
\end{algorithm}

\iffalse
Show reference model
Go over limitations
Introduce my model
\fi
